# 🎨 Arquitectura Visual del Módulo

## 📐 Diagrama de Arquitectura

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         INTERFAZ DE USUARIO                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────┐              ┌──────────────────────┐        │
│  │                      │              │                      │        │
│  │   POS FRONTEND       │              │   BACKEND VIEWS      │        │
│  │   (JavaScript)       │              │   (XML Forms)        │        │
│  │                      │              │                      │        │
│  │  ┌────────────────┐  │              │  ┌────────────────┐  │        │
│  │  │ Credit Button  │  │              │  │  Partner Form  │  │        │
│  │  │                │  │              │  │  - CC Tab      │  │        │
│  │  │ Shows Balance  │  │              │  │  - Movements   │  │        │
│  │  └────────────────┘  │              │  └────────────────┘  │        │
│  │                      │              │                      │        │
│  │  ┌────────────────┐  │              │  ┌────────────────┐  │        │
│  │  │ Credit Popup   │  │              │  │  Order Form    │  │        │
│  │  │                │  │              │  │  - Modify Btn  │  │        │
│  │  │ - Balance      │  │              │  │  - CC Info     │  │        │
│  │  │ - Movements    │  │              │  │  - PDF Btn     │  │        │
│  │  │ - Pay Button   │  │              │  └────────────────┘  │        │
│  │  └────────────────┘  │              │                      │        │
│  │                      │              │  ┌────────────────┐  │        │
│  │  ┌────────────────┐  │              │  │  Movement List │  │        │
│  │  │ Payment Screen │  │              │  │  - Filters     │  │        │
│  │  │                │  │              │  │  - Groups      │  │        │
│  │  │ - CC Method    │  │              │  └────────────────┘  │        │
│  │  └────────────────┘  │              │                      │        │
│  │                      │              │                      │        │
│  └──────────────────────┘              └──────────────────────┘        │
│            │                                      │                    │
└────────────┼──────────────────────────────────────┼────────────────────┘
             │                                      │
             └──────────────┬───────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           LÓGICA DE NEGOCIO                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │              │  │              │  │              │                 │
│  │ res.partner  │  │  pos.order   │  │ pos.credit   │                 │
│  │              │  │              │  │ .movement    │                 │
│  │ ┌──────────┐ │  │ ┌──────────┐ │  │              │                 │
│  │ │ Balance  │ │  │ │ CC Amount│ │  │ ┌──────────┐ │                 │
│  │ │ Compute  │ │  │ │ Compute  │ │  │ │   Type   │ │                 │
│  │ └──────────┘ │  │ └──────────┘ │  │ │  - Sale  │ │                 │
│  │              │  │              │  │ │  - Pay   │ │                 │
│  │ ┌──────────┐ │  │ ┌──────────┐ │  │ │  - Add   │ │                 │
│  │ │  Stats   │ │  │ │ Modify   │ │  │ │  - Remove│ │                 │
│  │ │ Compute  │ │  │ │ Methods  │ │  │ └──────────┘ │                 │
│  │ └──────────┘ │  │ └──────────┘ │  │              │                 │
│  │              │  │              │  │ ┌──────────┐ │                 │
│  │ ┌──────────┐ │  │ ┌──────────┐ │  │ │  State   │ │                 │
│  │ │ Actions  │ │  │ │ Validate │ │  │ │  - Draft │ │                 │
│  │ │ - Pay    │ │  │ │ Rules    │ │  │ │  - Conf  │ │                 │
│  │ │ - View   │ │  │ └──────────┘ │  │ │  - Cancel│ │                 │
│  │ └──────────┘ │  │              │  │ └──────────┘ │                 │
│  │              │  │              │  │              │                 │
│  └──────────────┘  └──────────────┘  └──────────────┘                 │
│         │                  │                  │                        │
│         └──────────────────┼──────────────────┘                        │
│                            │                                           │
└────────────────────────────┼───────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          CAPA DE DATOS                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────────────────────────────┐        │
│  │                    PostgreSQL Database                     │        │
│  │                                                            │        │
│  │  ┌───────────┐  ┌───────────┐  ┌────────────────────┐    │        │
│  │  │ res_      │  │ pos_      │  │ pos_credit_        │    │        │
│  │  │ partner   │  │ order     │  │ movement           │    │        │
│  │  │           │  │           │  │                    │    │        │
│  │  │ - id      │  │ - id      │  │ - id               │    │        │
│  │  │ - name    │  │ - name    │  │ - partner_id (FK)  │    │        │
│  │  │ - credit_ │  │ - partner │  │ - order_id (FK)    │    │        │
│  │  │   balance │  │   _id(FK) │  │ - movement_type    │    │        │
│  │  │           │  │ - has_cc  │  │ - amount           │    │        │
│  │  └───────────┘  │ - credit_ │  │ - state            │    │        │
│  │                 │   amount  │  │ - date             │    │        │
│  │                 └───────────┘  └────────────────────┘    │        │
│  │                                                            │        │
│  └────────────────────────────────────────────────────────────┘        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 Flujo de Venta a Crédito

```
    USUARIO                 POS                  BACKEND              DATABASE
       │                     │                      │                     │
       │  1. Agregar         │                      │                     │
       │  Productos          │                      │                     │
       ├────────────────────>│                      │                     │
       │                     │                      │                     │
       │  2. Seleccionar     │                      │                     │
       │  Cliente            │                      │                     │
       ├────────────────────>│                      │                     │
       │                     │                      │                     │
       │  3. Click Botón CC  │                      │                     │
       ├────────────────────>│  get_credit_info     │                     │
       │                     ├─────────────────────>│  SELECT movements   │
       │                     │                      ├────────────────────>│
       │                     │                      │<────────────────────┤
       │                     │<─────────────────────┤   balance, moves    │
       │  4. Ver Popup       │                      │                     │
       │<────────────────────┤                      │                     │
       │                     │                      │                     │
       │  5. Ir a Pago       │                      │                     │
       ├────────────────────>│                      │                     │
       │                     │                      │                     │
       │  6. Pago CC $5000   │                      │                     │
       ├────────────────────>│                      │                     │
       │                     │                      │                     │
       │  7. Validar Orden   │                      │                     │
       ├────────────────────>│  create(pos.order)   │                     │
       │                     ├─────────────────────>│  INSERT pos_order   │
       │                     │                      ├────────────────────>│
       │                     │                      │<────────────────────┤
       │                     │                      │                     │
       │                     │                      │  INSERT movement    │
       │                     │                      │  (type: sale)       │
       │                     │                      ├────────────────────>│
       │                     │                      │<────────────────────┤
       │                     │                      │                     │
       │                     │                      │  UPDATE partner     │
       │                     │                      │  (credit_balance)   │
       │                     │                      ├────────────────────>│
       │                     │<─────────────────────┤<────────────────────┤
       │  8. Confirmación    │                      │                     │
       │<────────────────────┤                      │                     │
       │                     │                      │                     │
```

## 🔄 Flujo de Modificación de Orden

```
    USUARIO                 BACKEND                                   DATABASE
       │                      │                                           │
       │  1. Abrir Orden      │                                           │
       ├─────────────────────>│  read(pos.order)                         │
       │                      ├──────────────────────────────────────────>│
       │                      │<──────────────────────────────────────────┤
       │                      │                                           │
       │  2. Click "Modificar"│                                           │
       ├─────────────────────>│  action_modify_order()                   │
       │                      │                                           │
       │                      │  ┌─────────────────────────────┐         │
       │                      │  │ Validar tipo de pago:       │         │
       │                      │  │ - ¿Tiene CC? → ✅          │         │
       │                      │  │ - ¿100% Efectivo? → ❌     │         │
       │                      │  └─────────────────────────────┘         │
       │                      │                                           │
       │  3. Agregar Producto │                                           │
       │  (+$1000)            │                                           │
       ├─────────────────────>│  add_products_to_order()                 │
       │                      │                                           │
       │                      │  ┌─────────────────────────────┐         │
       │                      │  │ Calcular proporción:        │         │
       │                      │  │ CC = 60% → +$600            │         │
       │                      │  │ Efectivo = 40% (no cambia)  │         │
       │                      │  └─────────────────────────────┘         │
       │                      │                                           │
       │                      │  INSERT pos.order.line                    │
       │                      ├──────────────────────────────────────────>│
       │                      │<──────────────────────────────────────────┤
       │                      │                                           │
       │                      │  INSERT pos.credit.movement               │
       │                      │  (type: product_add, amount: +$600)       │
       │                      ├──────────────────────────────────────────>│
       │                      │<──────────────────────────────────────────┤
       │                      │                                           │
       │                      │  UPDATE pos.order                         │
       │                      │  (current_value, is_modified=True)        │
       │                      ├──────────────────────────────────────────>│
       │                      │<──────────────────────────────────────────┤
       │                      │                                           │
       │                      │  COMPUTE credit_amount_due                │
       │                      │  (suma todos los movimientos)             │
       │                      ├──────────────────────────────────────────>│
       │                      │<──────────────────────────────────────────┤
       │                      │                                           │
       │  4. Confirmación     │                                           │
       │<─────────────────────┤                                           │
       │                      │                                           │
```

## 🔄 Flujo de Pago

```
    USUARIO                 BACKEND                                   DATABASE
       │                      │                                           │
       │  1. Click            │                                           │
       │  "Registrar Pago"    │                                           │
       ├─────────────────────>│  action_register_payment()               │
       │                      │                                           │
       │  2. Formulario       │                                           │
       │<─────────────────────┤  (prepopulate amount)                    │
       │                      │                                           │
       │  3. Ingresar Monto   │                                           │
       │  (-$3000)            │                                           │
       ├─────────────────────>│                                           │
       │                      │                                           │
       │  4. Confirmar        │                                           │
       ├─────────────────────>│  create(pos.credit.movement)             │
       │                      │                                           │
       │                      │  INSERT movement                          │
       │                      │  (type: payment, amount: -$3000)          │
       │                      ├──────────────────────────────────────────>│
       │                      │<──────────────────────────────────────────┤
       │                      │                                           │
       │                      │  COMPUTE partner.credit_balance           │
       │                      │  (suma todos los movimientos)             │
       │                      ├──────────────────────────────────────────>│
       │                      │<──────────────────────────────────────────┤
       │                      │                                           │
       │  5. Saldo Actualizado│                                           │
       │<─────────────────────┤                                           │
       │                      │                                           │
```

## 📊 Cálculo de Saldo

```
┌──────────────────────────────────────────────────────────────┐
│              CÁLCULO DE SALDO (credit_balance)               │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  SELECT SUM(amount)                                          │
│  FROM pos_credit_movement                                    │
│  WHERE partner_id = X                                        │
│    AND state = 'confirmed'                                   │
│                                                              │
│  Movimientos:                                                │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 1. Venta inicial          → +$5,000                │     │
│  │ 2. Productos agregados    → +$1,200                │     │
│  │ 3. Productos removidos    → -$800                  │     │
│  │ 4. Pago recibido          → -$3,000                │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  Total: $5,000 + $1,200 - $800 - $3,000 = $2,400            │
│                                                              │
│  Resultado: Cliente debe $2,400                             │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## 🎯 Matriz de Decisiones: Modificar Orden

```
┌─────────────────────────────────────────────────────────────────────┐
│               ¿QUÉ PUEDE HACER EL CLIENTE?                          │
├──────────────┬────────────────────┬────────────────────────────────┤
│ TIPO DE PAGO │   AGREGAR PRODUCTOS│   QUITAR PRODUCTOS             │
├──────────────┼────────────────────┼────────────────────────────────┤
│              │                    │                                │
│ 100% Efectivo│   ❌ NO PERMITIDO  │   ✅ PERMITIDO                 │
│              │   → Nueva venta    │   → Crédito a favor            │
│              │                    │                                │
├──────────────┼────────────────────┼────────────────────────────────┤
│              │                    │                                │
│ 100% CC      │   ✅ PERMITIDO     │   ✅ PERMITIDO                 │
│              │   → Aumenta deuda  │   → Reduce deuda               │
│              │                    │                                │
├──────────────┼────────────────────┼────────────────────────────────┤
│              │                    │                                │
│ Mixto        │   ✅ PERMITIDO     │   ✅ PERMITIDO                 │
│ (Efectivo +  │   → Aumenta deuda  │   → Reduce deuda               │
│  CC)         │   (proporcional)   │   (proporcional)               │
│              │                    │                                │
└──────────────┴────────────────────┴────────────────────────────────┘
```

## 📈 Estados de los Movimientos

```
┌────────────────────────────────────────────────────────────┐
│              CICLO DE VIDA DE UN MOVIMIENTO                │
└────────────────────────────────────────────────────────────┘

         ┌─────────┐
         │  DRAFT  │  ← Creado manualmente (ej: ajuste)
         └────┬────┘
              │
              │ action_confirm()
              ▼
         ┌─────────┐
         │CONFIRMED│  ← Auto-confirmado si viene de orden
         └────┬────┘
              │
              │ ✅ SE SUMA AL SALDO
              │
         ┌────┴────┐
         │         │
         ▼         ▼
    (Permanente) (action_cancel)
                  │
                  ▼
             ┌─────────┐
             │CANCELLED│  ← NO se suma al saldo
             └─────────┘
```

## 🏗️ Dependencias del Módulo

```
┌────────────────────────────────────────────────────────────┐
│              pos_customer_credit                           │
└────────────────────────────────────────────────────────────┘
         │
         │ depends on:
         │
         ├──> point_of_sale  (Módulo POS base)
         │         │
         │         ├──> models: pos.order, pos.order.line, etc.
         │         └──> views: POS interface
         │
         ├──> account  (Facturación)
         │         │
         │         └──> models: account.move (facturas)
         │
         ├──> sale  (Ventas)
         │
         └──> stock  (Inventario - opcional)
                   │
                   └──> Para control de inventario avanzado
```

Este diagrama muestra cómo el módulo se integra con los módulos base de Odoo.
